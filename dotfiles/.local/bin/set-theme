#!/usr/bin/env bash

set -euo pipefail

IFS=$'\n\t'
CONFIG_DIR="$HOME/.config/"
WAL_CACHE_DIR="$HOME/.cache/wal/"
XRESOURCES_PATH="$HOME/.Xresources"

path="${1:-}"

show_help() {
    cat <<EOF
Usage: ${0##*/} [PATH_TO_IMAGE_OR_DIRECTORY]

If PATH is provided, opens nsxiv to select an image and generates theme from it.
If no PATH is provided, restores the previous theme from cache.

Options:
  -h, --help    Show this help message and exit.

Examples:
  ${0##*/} ~/Pictures/wallpapers
  ${0##*/}               
EOF
}

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    show_help
    exit 0
fi

set_qt_colors() {
    local config_path="$1"

    cat "${WAL_CACHE_DIR}qt-wal.conf" > "$config_path"
}

set_gtk_colors() {
    themix-oomox-gtk-theme -o wal-colors "${WAL_CACHE_DIR}colors-oomox"
    themix-archdroid-icon-theme -o wal-icons "${WAL_CACHE_DIR}colors-oomox"
}

set_flameshot_colors() {
    cat "${WAL_CACHE_DIR}flameshot.ini" > "${CONFIG_DIR}flameshot.ini"
}

set_dunst_colors() {
    cat "${WAL_CACHE_DIR}dunstrc" > "${CONFIG_DIR}dunst/dunstrc"

    dunstctl reload
}

set_dwm_colors() {
    cat "${WAL_CACHE_DIR}.Xresources" > "$XRESOURCES_PATH"

    xrdb -merge "$XRESOURCES_PATH"
    xdotool key Super+F5
}

set_rofi_colors() {
    cat "${WAL_CACHE_DIR}colors-rofi-dark.rasi" > "${CONFIG_DIR}rofi/colors-rofi-dark.rasi"
}

set_theme() {
    pywalfox update

    set_dwm_colors
    set_rofi_colors
    set_flameshot_colors
    set_dunst_colors
    wal-telegram --palette "${WAL_CACHE_DIR}colors.sh" -g -r
    set_qt_colors "${CONFIG_DIR}qt5ct/colors/qt-wal.conf"
    set_qt_colors "${CONFIG_DIR}qt6ct/colors/qt-wal.conf"
    set_gtk_colors
}

set_wallpaper() {
    image_path=$1

    feh --bg-fill "$1"
}

choose_wallpaper() {
    image_path=$(find "$path" -type f | nsxiv -b -t -o -i)
    set_wallpaper "$image_path"

    echo "$image_path"
}

restore_wallpaper() {
    ~/.fehbg
}

restore_previous_theme() {
    restore_wallpaper
    wal -R -q -n 
}

apply_new_theme() {
    local path="$1"

    if [[ ! -e "$path" ]]; then
        echo "Error: path '$path' not exist."
        exit 1
    fi

    local image_path
    image_path=$(choose_wallpaper)

    if [[ -z "$image_path" ]]; then
        echo "Exit: Image not found."
        exit 1
    fi

    wal --cols16 -q -i "$image_path" -n
    set_wallpaper "$image_path"
    set_theme
}

apply_colorscheme() {
    theme_name=$(wal --theme | grep -Ev "(Extra|Light Themes|Dark Themes)" | cut -d ' ' -f 3 | dmenu -l 20 -c -bw 2 -p "Colorscheme:")
    
    wal --theme "$theme_name"
    set_theme
}

main() {
    if [[ -z "$path" ]]; then
        restore_previous_theme
    else
        choice=$(printf "Set wallpaper\nApply colorscheme\nGenerate theme" | dmenu -i -p "What to do?")

        case "$choice" in
            "Set wallpaper")
                choose_wallpaper
                ;;
            "Apply colorscheme")
                apply_colorscheme
                ;;
            "Generate theme")
                apply_new_theme "$path"
                ;;
            *)
                exit 1
                ;;
        esac
    fi
}

main
